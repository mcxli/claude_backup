#!/usr/bin/env python3
"""
Claude Code ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ - æ®µéš2
å±é™ºãªã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åŒ…æ‹¬çš„ã«æ¤œå‡ºã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
- ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã‚’è¿½åŠ 
- é–“æ¥å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã‚’è¿½åŠ 
- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡ºã‚’å¼·åŒ–
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„

è¨­ç½®å ´æ‰€: ~/.claude/security-validator.py
å®Ÿè¡Œæ¨©é™: chmod +x ~/.claude/security-validator.py
"""

import json
import sys
import re
import datetime
import os
from pathlib import Path

def log_security_event(command, action, reason):
    """ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ã‚°ã«è¨˜éŒ²"""
    try:
        log_dir = Path.home() / ".claude" / "logs"
        log_dir.mkdir(parents=True, exist_ok=True)
        log_file = log_dir / "security.log"
        
        log_entry = {
            "timestamp": datetime.datetime.now().isoformat(),
            "command": command,
            "action": action,
            "reason": reason,
            "user": os.getenv("USER", "unknown"),
            "pwd": os.getcwd()
        }
        
        with open(log_file, 'a', encoding='utf-8') as f:
            f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
    except Exception as e:
        # ãƒ­ã‚°æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«å¤±æ•—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã¯ç¶™ç¶šï¼‰
        # stderr ã«æœ€å°é™ã®ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
        print(f"# Log write error: {e}", file=sys.stderr)

def is_dangerous_command(command):
    """
    å±é™ºãªã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åŒ…æ‹¬çš„ã«ãƒã‚§ãƒƒã‚¯
    æ®µéš2: ã‚·ã‚¹ãƒ†ãƒ ç ´å£Šãƒªã‚¹ã‚¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€é–“æ¥å®Ÿè¡Œã‚’æ¤œå‡º
    """
    
    # è¶…å±é™ºã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆçµ¶å¯¾ã«ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
    CRITICAL_PATTERNS = [
        # sudoç³»ï¼ˆæ¨©é™æ˜‡æ ¼ï¼‰
        (r'sudo\s+.*', "Rootæ¨©é™ã§ã®å®Ÿè¡Œã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'su\s+.*', "ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        
        # å†å¸°å‰Šé™¤ç³»ï¼ˆãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ï¼‰
        (r'rm\s+-[rf]*r[rf]*\s+.*', "å†å¸°å‰Šé™¤ã¯éå¸¸ã«å±é™ºã§ã™"),
        (r'rm\s+-[rf]*f[rf]*\s+.*/.+', "å¼·åˆ¶å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'rm\s+--recursive\s+.*', "å†å¸°å‰Šé™¤ã¯éå¸¸ã«å±é™ºã§ã™"),
        (r'rm\s+--force\s+.*/.+', "å¼·åˆ¶å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'rm\s+-r\s+\\*', "å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å†å¸°å‰Šé™¤ã¯æ¥µã‚ã¦å±é™ºã§ã™"),
        (r'rm\s+--recursive\s+\\*', "å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å†å¸°å‰Šé™¤ã¯æ¥µã‚ã¦å±é™ºã§ã™"),
        (r'rm\s+-rf\s+/', "ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'rm\s+-rf\s+~', "ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'rm\s+-rf\s+\.', "ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'find\s+.*-delete', "findã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'find\s+.*-exec\s+rm', "findã‚³ãƒãƒ³ãƒ‰çµŒç”±ã®å‰Šé™¤ã¯å±é™ºã§ã™"),
        
        # ãƒ‡ã‚£ã‚¹ã‚¯æ“ä½œç³»ï¼ˆå¾©æ—§ä¸å¯èƒ½ï¼‰
        (r'dd\s+.*', "ãƒ‡ã‚£ã‚¹ã‚¯ç›´æ¥æ“ä½œã¯æ¥µã‚ã¦å±é™ºã§ã™"),
        (r'fdisk\s+.*', "ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ“ä½œã¯å±é™ºã§ã™"),
        (r'parted\s+.*', "ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ“ä½œã¯å±é™ºã§ã™"),
        (r'mkfs\s+.*', "ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½œæˆã¯å±é™ºã§ã™"),
        
        # ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡ç³»ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ï¼‰
        (r'shutdown\s+.*', "ã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'poweroff\s+.*', "ã‚·ã‚¹ãƒ†ãƒ é›»æºåˆ‡æ–­ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'reboot\s+.*', "ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'halt\s+.*', "ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'init\s+[06]', "ã‚·ã‚¹ãƒ†ãƒ åœæ­¢/å†èµ·å‹•ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'systemctl\s+(poweroff|reboot|halt|shutdown)', "systemctlçµŒç”±ã®ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'service\s+.*\s+(stop|restart)\s*$', "é‡è¦ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢/å†èµ·å‹•ã¯å±é™ºã§ã™"),
        (r'telinit\s+[06]', "ã‚·ã‚¹ãƒ†ãƒ åœæ­¢/å†èµ·å‹•ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        
        # æ¨©é™å¤‰æ›´ç³»ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
        (r'chmod\s+777\s+.*', "å…¨ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ä»˜ä¸ã¯å±é™ºã§ã™"),
        (r'chmod\s+-R\s+777\s+.*', "å†å¸°çš„ãªå…¨æ¨©é™ä»˜ä¸ã¯æ¥µã‚ã¦å±é™ºã§ã™"),
        (r'chmod\s+-R\s+777\s+\\*', "å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å†å¸°çš„ãªå…¨æ¨©é™ä»˜ä¸ã¯æ¥µã‚ã¦å±é™ºã§ã™"),
        (r'chmod\s+[ago]\+rwx\s+.*', "å…¨ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ä»˜ä¸ã¯å±é™ºã§ã™"),
        (r'chmod\s+-R\s+666\s+.*', "å†å¸°çš„ãªæ›¸ãè¾¼ã¿æ¨©é™ä»˜ä¸ã¯å±é™ºã§ã™"),
        (r'chown\s+root\s+.*', "rootæ‰€æœ‰æ¨©å¤‰æ›´ã¯å±é™ºã§ã™"),
        (r'chown\s+-R\s+root:root\s+/', "ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®rootæ‰€æœ‰æ¨©å¤‰æ›´ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        
        # ãƒ—ãƒ­ã‚»ã‚¹å¼·åˆ¶çµ‚äº†ç³»
        (r'kill\s+-9\s+1\s*$', "init ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'kill\s+-KILL\s+1\s*$', "init ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'killall\s+-9\s+.*', "ä¸€æ‹¬å¼·åˆ¶çµ‚äº†ã¯å±é™ºã§ã™"),
        (r'pkill\s+-9\s+.*', "ãƒ—ãƒ­ã‚»ã‚¹åã«ã‚ˆã‚‹å¼·åˆ¶çµ‚äº†ã¯å±é™ºã§ã™"),
        (r'pkill\s+-KILL\s+.*', "ãƒ—ãƒ­ã‚»ã‚¹åã«ã‚ˆã‚‹å¼·åˆ¶çµ‚äº†ã¯å±é™ºã§ã™"),
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
        (r'rm\s+.*/(etc|boot|usr|bin|sbin|var|lib|opt)/.*', "ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã¯å±é™ºã§ã™"),
        (r'.*>\s*/dev/(sda|sdb|sdc|nvme).*', "ãƒ‡ã‚£ã‚¹ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã¸ã®æ›¸ãè¾¼ã¿ã¯å±é™ºã§ã™"),
        (r'>\s*/etc/(passwd|shadow|group|sudoers)', "é‡è¦ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ä¸Šæ›¸ãã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'>>\s*/etc/(passwd|shadow|group|sudoers)', "é‡è¦ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®è¿½è¨˜ã¯å±é™ºã§ã™"),
        (r'truncate\s+.*/(etc|boot|usr|bin|sbin)/', "ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ‡ã‚Šè©°ã‚ã¯å±é™ºã§ã™"),
        (r'shred\s+.*/(etc|boot|usr|bin|sbin)/', "ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Œå…¨å‰Šé™¤ã¯å±é™ºã§ã™"),
        
        # å±é™ºãªãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼
        (r':\(\)\{\s*:\|\:&\s*\};\:', "ãƒ•ã‚©ãƒ¼ã‚¯ãƒœãƒ ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"),
        (r'cat\s+/dev/zero\s*>\s*.*', "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’æ¶ˆè²»ã™ã‚‹æ“ä½œã¯å±é™ºã§ã™"),
        
        # ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º
        (r';\s*(sudo|rm\s+-rf?|dd|shutdown|reboot)', "ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"),
        (r'&&\s*(sudo|rm\s+-rf?|dd|shutdown|reboot)', "ã‚³ãƒãƒ³ãƒ‰é€£çµã«ã‚ˆã‚‹å±é™ºãªæ“ä½œã§ã™"),
        (r'\|\|\s*(sudo|rm\s+-rf?|dd|shutdown|reboot)', "ã‚³ãƒãƒ³ãƒ‰é€£çµã«ã‚ˆã‚‹å±é™ºãªæ“ä½œã§ã™"),
        (r'\|\s*(sudo|rm\s+-rf?|dd|shutdown)', "ãƒ‘ã‚¤ãƒ—ã«ã‚ˆã‚‹å±é™ºãªæ“ä½œã§ã™"),
        (r'`[^`]*rm\s+-rf?[^`]*`', "ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®å±é™ºãªæ“ä½œã§ã™"),
        (r'\$\([^)]*rm\s+-rf?[^)]*\)', "ã‚³ãƒãƒ³ãƒ‰ç½®æ›å†…ã®å±é™ºãªæ“ä½œã§ã™"),
        (r'`[^`]*sudo[^`]*`', "ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®rootæ¨©é™æ“ä½œã§ã™"),
        (r'\$\([^)]*sudo[^)]*\)', "ã‚³ãƒãƒ³ãƒ‰ç½®æ›å†…ã®rootæ¨©é™æ“ä½œã§ã™"),
        
        # é–“æ¥å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
        (r'(sh|bash|zsh|ksh)\s+-c\s+["\'].*rm\s+-rf?.*["\']', "ã‚·ã‚§ãƒ«çµŒç”±ã®å±é™ºãªæ“ä½œã§ã™"),
        (r'(sh|bash|zsh|ksh)\s+-c\s+["\'].*sudo.*["\']', "ã‚·ã‚§ãƒ«çµŒç”±ã®rootæ¨©é™æ“ä½œã§ã™"),
        (r'eval\s+["\'].*rm\s+-rf?.*["\']', "evalçµŒç”±ã®å±é™ºãªæ“ä½œã§ã™"),
        (r'eval\s+["\'].*sudo.*["\']', "evalçµŒç”±ã®rootæ¨©é™æ“ä½œã§ã™"),
        (r'exec\s+.*rm\s+-rf?', "execçµŒç”±ã®å±é™ºãªæ“ä½œã§ã™"),
        (r'exec\s+.*sudo', "execçµŒç”±ã®rootæ¨©é™æ“ä½œã§ã™"),
        (r'source\s+.*\.(sh|bash)', "ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®sourceã¯å±é™ºã§ã™"),
        (r'\.\s+.*\.(sh|bash)', "ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®sourceã¯å±é™ºã§ã™"),
        (r'echo\s+["\'].*rm\s+-rf?.*["\']\s*\|\s*(sh|bash)', "ãƒ‘ã‚¤ãƒ—çµŒç”±ã®å±é™ºãªå®Ÿè¡Œã§ã™"),
        (r'printf\s+["\'].*rm\s+-rf?.*["\']\s*\|\s*(sh|bash)', "ãƒ‘ã‚¤ãƒ—çµŒç”±ã®å±é™ºãªå®Ÿè¡Œã§ã™"),
    ]
    
    for pattern, reason in CRITICAL_PATTERNS:
        if re.search(pattern, command, re.IGNORECASE):
            return True, reason
    
    return False, None

def main():
    try:
        # æ¨™æº–å…¥åŠ›ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
        data = json.load(sys.stdin)
        
        # ã‚³ãƒãƒ³ãƒ‰æŠ½å‡º
        tool_input = data.get('tool_input', {})
        command = tool_input.get('command', '')
        
        if not command:
            # ã‚³ãƒãƒ³ãƒ‰ãŒç©ºã®å ´åˆã¯é€šã™
            print(json.dumps({"decision": "approve"}))
            return
        
        # å±é™ºãªã‚³ãƒãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯
        is_dangerous, reason = is_dangerous_command(command)
        
        if is_dangerous:
            # ãƒ­ã‚°è¨˜éŒ²
            log_security_event(command, "BLOCKED", reason)
            
            # ãƒ–ãƒ­ãƒƒã‚¯å¿œç­”
            result = {
                "decision": "block",
                "reason": f"""ğŸš« SECURITY ALERT: ã‚³ãƒãƒ³ãƒ‰ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ

ã‚³ãƒãƒ³ãƒ‰: {command}
ç†ç”±: {reason}

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã‚·ã‚¹ãƒ†ãƒ ã«æ·±åˆ»ãªæå®³ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
å®‰å…¨ãªä»£æ›¿æ‰‹æ®µã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°: ~/.claude/logs/security.log"""
            }
            
            print(json.dumps(result, ensure_ascii=False))
            
        else:
            # å®‰å…¨ãªã‚³ãƒãƒ³ãƒ‰ã¯é€šã™
            print(json.dumps({"decision": "approve"}))
            
    except json.JSONDecodeError as e:
        # JSONè§£æã‚¨ãƒ©ãƒ¼
        raw_input = str(sys.stdin.buffer.read() if hasattr(sys.stdin, 'buffer') else '<stdin>')[:200]
        log_security_event(f"INVALID_JSON: {raw_input}", "ERROR", f"Failed to parse hook input: {str(e)}")
        result = {
            "decision": "block",
            "reason": "ğŸš« Hookå…¥åŠ›ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"
        }
        print(json.dumps(result, ensure_ascii=False))
        
    except Exception as e:
        # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
        log_security_event("HOOK_ERROR", "ERROR", str(e))
        # ã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ã«å€’ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯
        result = {
            "decision": "block",
            "reason": f"ğŸš« å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
        }
        print(json.dumps(result, ensure_ascii=False))

if __name__ == "__main__":
    main()
